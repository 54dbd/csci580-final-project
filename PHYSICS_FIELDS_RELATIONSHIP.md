# 火焰模拟中各物理场的关系

本文档详细说明火焰模拟系统中各个物理场（速度场、温度场、燃料场、压力场、密度场）之间的相互作用关系。

## 📊 物理场概览

### 核心场（Core Fields）

1. **速度场 (Velocity Field)** - `velocity`
   - 类型：RG 格式（双通道）
   - 存储：每个像素的 (vx, vy) 速度向量
   - 作用：驱动所有其他场的运动

2. **温度场 (Temperature Field)** - `temperature`
   - 类型：单通道浮点
   - 存储：每个像素的温度值
   - 作用：产生浮力，影响火焰颜色

3. **燃料场 (Fuel Field)** - `fuel`
   - 类型：单通道浮点
   - 存储：每个像素的燃料量
   - 作用：燃烧产生温度

4. **密度场 (Density Field)** - `density`
   - 类型：RGBA 格式（四通道）
   - 存储：颜色/烟雾信息
   - 作用：视觉效果（颜色和透明度）

5. **压力场 (Pressure Field)** - `pressure`
   - 类型：单通道浮点
   - 存储：压力值
   - 作用：修正速度场，使其满足不可压缩条件

## 🔄 场之间的相互作用关系

### 关系图

```
┌─────────────┐
│   燃料场    │ ──┐
│   (Fuel)    │   │
└─────────────┘   │
                  │ 燃烧过程
┌─────────────┐   │
│   温度场    │ ◄─┘
│(Temperature)│   │
└─────────────┘   │
      │           │
      │ 浮力      │
      ▼           │
┌─────────────┐   │
│   速度场    │   │
│  (Velocity) │   │
└─────────────┘   │
      │           │
      │ 平流      │
      ├───────────┘
      │
      ├──► 密度场 (Density) - 颜色/烟雾
      ├──► 温度场 (Temperature) - 被携带
      ├──► 燃料场 (Fuel) - 被携带
      │
      ▼
┌─────────────┐
│   压力场    │ ◄── 从速度场计算（散度）
│  (Pressure) │
└─────────────┘
      │
      │ 压力投影
      ▼
┌─────────────┐
│   速度场    │ ◄── 修正速度场（使其无散）
│  (Velocity) │
└─────────────┘
```

## 📝 详细相互作用说明

### 1. 燃料场 → 温度场（燃烧过程）

**关系类型：** 单向转换

**过程：**
- 燃料在达到燃烧温度时转化为热量
- 公式：`temp = max(temp, fuel * burnTemperature)`
- 温度至少等于燃料量 × 燃烧温度

**代码位置：** `combustionShader.glsl`

```glsl
// 燃料产生温度
float fuelTemperature (float fuel) {
  return fuel * burnTemperature;
}

// 温度至少等于燃料产生的温度
temp = max(temp, fuelTemperature(fuel));
```

**特点：**
- 燃料是温度的"燃料源"
- 燃料越多，产生的温度越高
- 燃料在燃烧过程中会逐渐消耗（通过耗散）

### 2. 温度场 → 速度场（浮力效应）

**关系类型：** 单向影响

**过程：**
- 热空气密度小，受到向上的浮力
- 温度越高，浮力越大
- 浮力冲量：`impulse = dt * buoyancy * temperature * (0, 1)`
- 新速度 = 旧速度 + 浮力冲量

**代码位置：** `buoyancyShader.glsl`

```glsl
// 根据温度计算浮力冲量
vec2 impulse = dt * buoyancy * dTemp * vec2(0.0, 1.0);
// 添加到速度
gl_FragColor = vec4(vel + impulse, 0.0, 1.0);
```

**特点：**
- 这是火焰上升的主要原因
- 温度越高，上升速度越快
- 浮力方向始终向上（Y 轴正方向）

### 3. 速度场 → 所有标量场（平流过程）

**关系类型：** 单向影响

**过程：**
- 所有标量场（密度、温度、燃料）都随速度场移动
- 使用半拉格朗日平流方法
- 公式：`新值 = 在(位置 - 速度*时间)处的旧值`

**代码位置：** `advectionShader.glsl`

```glsl
// 从当前位置回溯，找到来源位置
vec2 coord = vUv - dt * texture2D(uVelocity, vUv).xy * texelSize;
// 在回溯位置采样源场
gl_FragColor = dissipation * texture2D(uSource, coord);
```

**影响的场：**
1. **密度场**：颜色/烟雾随流体移动
2. **温度场**：热量随流体移动
3. **燃料场**：燃料随流体移动
4. **噪声场**：湍流随流体移动

**特点：**
- 速度场是"运输工具"，携带所有物质
- 不同场有不同的耗散率（dissipation）
- 密度场使用更高分辨率以获得更清晰的视觉效果

### 4. 速度场 ↔ 压力场（压力投影）

**关系类型：** 双向影响

**过程：**

#### 4.1 速度场 → 压力场
- 计算速度场的散度：`divergence = ∂u/∂x + ∂v/∂y`
- 求解泊松方程：`∇²p = divergence`
- 使用 Jacobi 迭代法求解压力场

#### 4.2 压力场 → 速度场
- 从速度场中减去压力梯度：`u_new = u_old - ∇p`
- 使速度场满足不可压缩条件：`div(u) = 0`

**代码位置：** 
- `divergenceShader.glsl` - 计算散度
- `pressureIterationShader.glsl` - 求解压力
- `projectionShader.glsl` - 压力投影

**特点：**
- 压力场是临时计算场，不直接存储物理量
- 用于修正速度场，模拟不可压缩流体
- 压力投影是流体模拟的核心步骤

### 5. 温度场 + 燃料场 + 密度场 → 最终渲染

**关系类型：** 组合渲染

**过程：**
- **温度场**：决定火焰颜色（黑体辐射）
- **燃料场**：决定火焰可见度（visibility）
- **密度场**：提供颜色和烟雾效果

**代码位置：** `displayFireShader.glsl`

```glsl
// 读取各场
float temp = texture2D(uTemperature, vUv).x;
float fuel = texture2D(uFuel, vUv).x;
vec4 density = texture2D(uDensity, vUv);

// 根据燃料计算可见度
float visibility = (exp(10.*fuel)-exp(-10.*fuel))/(exp(10.*fuel)+exp(-10.*fuel));

// 根据温度计算黑体辐射颜色
vec3 color = blackbody(temp);

// 最终颜色 = 可见度 × 黑体颜色
gl_FragColor = vec4(visibility * color, 1.0);
```

**特点：**
- 温度决定颜色（高温=亮黄色/白色，低温=暗红色）
- 燃料决定亮度（燃料越多，火焰越亮）
- 密度提供额外的颜色和烟雾效果

## 🔄 每帧更新顺序

模拟每帧按以下顺序更新各场：

```
1. 粒子 → 燃料场（添加燃料）
   ↓
2. 燃料场 + 温度场 → 温度场（燃烧和冷却）
   ↓
3. 速度场 → 速度场（自平流）
   ↓
4. 速度场 → 速度场（涡度限制）
   ↓
5. 温度场 → 速度场（浮力）
   ↓
6. 速度场 → 压力场 → 速度场（压力投影）
   ↓
7. 速度场 → 密度场（平流）
   ↓
8. 速度场 → 温度场（平流）
   ↓
9. 速度场 → 燃料场（平流）
   ↓
10. 噪声场更新
```

## 📈 各场的生命周期

### 燃料场
- **产生**：粒子发射器、用户交互（splat）
- **消耗**：燃烧转化为温度
- **衰减**：每帧耗散（FUEL_DISSIPATION = 0.92）

### 温度场
- **产生**：燃料燃烧
- **衰减**：自然冷却（四次方模型）
- **移动**：随速度场平流

### 速度场
- **产生**：浮力、用户交互
- **衰减**：每帧耗散（VELOCITY_DISSIPATION = 0.98）
- **修正**：压力投影使其无散

### 密度场
- **产生**：用户交互（splat）
- **衰减**：每帧耗散（DENSITY_DISSIPATION = 0.99）
- **移动**：随速度场平流

### 压力场
- **产生**：从速度场散度计算
- **作用**：修正速度场
- **衰减**：每帧耗散（PRESSURE_DISSIPATION = 0.8）

## 🎯 关键参数影响

### BUOYANCY (浮力系数)
- **影响**：温度 → 速度的转换强度
- **值越大**：火焰上升越快

### BURN_TEMPERATURE (燃烧温度)
- **影响**：燃料 → 温度的转换
- **值越大**：需要更多燃料才能产生相同温度

### COOLING (冷却系数)
- **影响**：温度自然下降速度
- **值越大**：温度下降越快

### VELOCITY_DISSIPATION (速度耗散)
- **影响**：速度场的衰减
- **值越小**：速度衰减越快（模拟粘性）

### FUEL_DISSIPATION (燃料耗散)
- **影响**：燃料场的衰减
- **值越小**：燃料消失越快

### DENSITY_DISSIPATION (密度耗散)
- **影响**：颜色/烟雾的衰减
- **值越小**：颜色消失越快

## 🔬 物理模型总结

这个火焰模拟系统基于以下物理原理：

1. **Navier-Stokes 方程**：描述流体运动
2. **不可压缩条件**：div(u) = 0（通过压力投影实现）
3. **浮力原理**：热空气上升（阿基米德原理）
4. **黑体辐射**：温度决定颜色（Stefan-Boltzmann 定律）
5. **燃烧反应**：燃料 → 热量
6. **热传导**：温度自然冷却

所有场通过**平流（Advection）**过程相互关联，形成一个完整的物理系统。

